<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üéÅ Secret Bunutan</title>
<style>
  body {
    font-family: Poppins, Arial, sans-serif;
    background: #f8f9fd;
    color: #222;
    text-align: center;
    padding: 40px;
  }
  h1 { color: #333; margin-bottom: 10px; }
  button {
    padding: 10px 20px;
    margin: 10px;
    border: none;
    border-radius: 8px;
    background: #4CAF50;
    color: white;
    font-size: 16px;
    cursor: pointer;
    transition: 0.2s;
  }
  button:hover { background: #45a049; }
  button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  #drawn, #msg {
    margin-top: 20px;
    font-size: 20px;
  }
  .links {
    margin-top: 40px;
    font-size: 16px;
  }
  a {
    color: #007bff;
    text-decoration: none;
  }
  a:hover { text-decoration: underline; }
</style>
</head>
<body>

<h1>üéÅ Secret Bunutan</h1>
<p id="msg"></p>
<button id="drawBtn">Draw Your Bunot üé≤</button>
<div id="drawn"></div>
<div class="links" id="links"></div>

<script>
const assignedKey = "bunutan_assigned_v2";
const params = new URLSearchParams(window.location.search);
let user = params.get("user");

// Load assigned data from browser storage (optional per user)
function saveAssigned(obj){ localStorage.setItem(assignedKey, JSON.stringify(obj)); }
function loadAssigned(){ return JSON.parse(localStorage.getItem(assignedKey) || "{}"); }

// Fetch participant list from names.json
fetch("names.json")
  .then(r => r.json())
  .then(allNames => {
    // === Show all participant links if no ?user ===
    if (!user) {
      document.getElementById("msg").innerHTML = "<b>Click your name below to join:</b>";
      let html = "<ul style='list-style:none;padding:0;'>";
      allNames.forEach(name => {
        html += `<li><a href="?user=${encodeURIComponent(name)}">${name}</a></li>`;
      });
      html += "</ul>";
      document.getElementById("links").innerHTML = html;
      document.getElementById("drawBtn").style.display = "none";
      return;
    }

    // === Normalize username and match ===
    user = user.trim();
    const match = allNames.find(n => n.toLowerCase() === user.toLowerCase());
    if (!match) {
      document.body.innerHTML = "<h2>‚ö†Ô∏è Invalid participant link.</h2>";
      throw new Error("Invalid user");
    }
    user = match;

    document.getElementById("msg").innerHTML = `<b>Welcome, ${user}!</b><br>Click below to reveal your bunot üéÅ`;

    const drawBtn = document.getElementById("drawBtn");
    drawBtn.onclick = () => {
      let assigned = loadAssigned();
      if (assigned[user]) {
        document.getElementById("drawn").innerHTML = `üéâ You already got: <b>${assigned[user]}</b>`;
        drawBtn.disabled = true;
        return;
      }

      const used = Object.values(assigned);
      const available = allNames.filter(n => !used.includes(n) && n !== user);

      if (!available.length) {
        document.getElementById("drawn").innerHTML = "‚ö†Ô∏è No more names left!";
        drawBtn.disabled = true;
        return;
      }

      const chosen = available[Math.floor(Math.random() * available.length)];
      assigned[user] = chosen;
      saveAssigned(assigned);

      document.getElementById("drawn").innerHTML = `üéâ You got: <b>${chosen}</b>`;
      drawBtn.disabled = true;
    };
  })
  .catch(err => {
    document.body.innerHTML = `
      <h2>‚ö†Ô∏è Organizer hasn't uploaded the participant list yet.</h2>
      <p>Organizer: please add a <b>names.json</b> file in the same GitHub folder.</p>`;
    console.error(err);
  });
</script>

</body>
</html>
